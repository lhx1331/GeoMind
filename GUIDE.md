# 通用地理推理 Agent 技术设计

## 目标与背景

为了让模型不仅能"看图给答案"，而是像人类一样结合多模态感知、候选生成、检索和证据核验完成复杂任务，本设计文档提出了一种可复用的 PHRV 框架（Perception → Hypothesis → Retrieval → Verification）。首个应用场景是图像地理定位：给定一张照片，Agent 通过模块化的视觉模型、外部检索工具和验证逻辑推断其拍摄地点，并提供支撑线索。框架的核心价值在于：

- **模块化**：模型、提示模板与工具解耦，可随时替换；
- **可复用**：通过标准化状态与节点逻辑，可以快速定制新的推理任务；
- **可审计**：采用检索与验证闭环，输出结果必须附带证据链，减少幻觉；
- **沙盒集成**：Agent 可以在受控环境（sandbox）中调用自定义代码或工具扩展能力。

## 总体架构

架构可以分为三层：

### 1. 推理流程层（PHRV）
核心逻辑。输入图像后，Agent 首先使用视觉模型抽取线索（Perception），然后生成几个可能的地理假设（Hypothesis），利用地理检索工具缩小候选范围（Retrieval），最后用地图、POI 数据等工具验证候选并输出证据闭环（Verification）。

### 2. 可替换组件层
提供模型选择、提示模板和工具管理。不同场景可指定不同的大语言/多模态模型、GeoCLIP 检索模型或其他嵌入器，并能替换提示模板或外部工具而不修改流程。

### 3. 编排与状态管理层
使用 LangChain/LangGraph 等框架实现节点编排、状态持久化、循环控制以及沙盒调用。所有中间产物（线索、假设、候选、证据）存放在结构化 state 中，便于调试与日志化。

## PHRV 流程概述

| 阶段 | 主要职责 | 核心产物 |
|------|---------|---------|
| **Perception** | 调用视觉多模态模型（VLM）对输入图片或局部裁剪进行分析，抽取可用线索：OCR 文本、路标、建筑风格、道路走向、植被类型、车辆行驶方向、EXIF 等。 | `clues`：包含 OCR 文本、视觉实体、元数据。 |
| **Hypothesis** | 根据感知线索和先验（如语言、道路标线）生成若干地理假设（国家/城市/区域）。提示模板控制输出结构化的假设及其依据。 | `hypotheses`：每条包含假设区域、支持/冲突线索、置信度。 |
| **Retrieval** | 调用 GeoCLIP 或其他检索模型根据图片生成 Top‑K 候选坐标；使用 MCP 工具（地理编码、反向地理编码、POI 搜索）召回相关地点；结合假设区域过滤。 | `candidates`：每条包含候选地点名称、经纬度、来源和得分。 |
| **Verification** | 针对每个候选点，调用 MCP 工具校验 OCR 文本是否匹配当地店名/路名、道路拓扑是否一致、语言/标记是否一致，输出通过/失败及原因；循环直到某一候选通过验证或达到预定迭代次数。 | `evidence`：验证结果列表，包括候选标识、检查类型、结果、详细说明；`final`：最终答案、置信度、支撑证据、排除理由。 |

## 模块化组件设计

### 1. 模型层

#### 视觉模型 (VLM)
负责图像感知、线索抽取和假设生成。通过 `/v1/chat/completions` 风格的接口调用，无论背后连接的是托管服务还是自部署模型。在 GeoCLIP 实现的项目示例中，VLM 可取 LLaVA 或 Qwen‑VL 之类模型。提示模板强制模型输出 JSON 结构，便于后续流程解析。

#### 地理召回模型（GeoCLIP）
用于将图像嵌入与全球 GPS 坐标嵌入对齐，快速生成 Top‑K 候选。GeoCLIP 基于 CLIP 的对比学习思想训练，通过匹配图像‑GPS 对使正确的嵌入相近、错误的嵌入远离。开发者可选择托管版本或自行部署。由于模型规模仅约 90M 参数，CPU 推理也可满足低频需求。

使用示例：
```python
from geoclip import GeoCLIP
model = GeoCLIP()
top_pred_gps, top_pred_prob = model.predict(image_path, top_k=5)
```

该示例来自官方 README，模型将图片输出前 5 个坐标及其概率。

#### 语言模型 (LLM)
执行规划、策略生成、代码解释等任务，可使用 OpenAI 兼容模型或其他 LLMs。LLM 在 Hypothesis 阶段生成假设，在 Verification 阶段撰写验证策略与最终答案。可根据场景切换不同模型（例如在敏感环境使用本地模型）。

### 2. 提示模板

提示模板驱动 VLM 和 LLM 以结构化方式输出中间产物。模板包含以下部分：

- **系统提示** – 描述角色、任务规范、输出格式。例如要求 VLM 针对地理定位输出 JSON 字段：`clues`, `hypotheses`, `next_action` 等。
- **示例输入/输出** – 提供几组带图片/文字的实例以及对应的结构化输出，帮助模型对齐格式。
- **动态字段** – 根据当前 state 填充的上下文，如之前的线索、候选列表、历史失败原因等。
- **安全提示** – 指出禁止输出过于精确的住址、保护个人隐私。

模板应以函数或配置文件形式存储，可在不同场景下更换。例如对于室内物品识别，可以更换 Perception 阶段的线索类型（颜色、材质）和假设生成规则。

### 3. 工具层与 MCP 集成

工具是 Agent 从外部世界获取信息和执行动作的能力源。通过 MCP 协议注册服务可以快速接入新的工具。主要类别：

#### 检索类工具
- `geocode(text)` 将地名转成坐标
- `reverse_geocode(lat, lon)` 将坐标转成行政区/地址
- `poi_search(query, bbox)` 搜索店名、路名或电话区号

#### 核验类工具
- `match_ocr_to_poi(ocr_texts, poi_candidates)` 计算 OCR 文本与 POI 名称匹配度
- `road_topology_check(image_clues, map_features)` 比较道路走向、海岸线
- `language_region_prior(lang, scripts)` 根据文字语言预判所属区域

#### 沙盒工具
在受控环境中运行代码，例如分析 EXIF 元数据或基于 GeoCLIP 生成嵌入。使用 `python_user_visible` 或自定义 codegen 工具，在 Verification 阶段自动执行批量验证。

工具通过统一接口注册：每个工具定义输入参数、输出格式及描述，注册到 MCP 后可在 LLM 输出的 plan 中调用。工具的输出应该包括可引用的证据，如 POI 名称、坐标和来源 URL，用于日志和解释。

### 4. 配置与交换机制

为了适配不同任务和环境，框架需要提供：

- **模型选择配置**：通过配置文件或数据库指定 VLM、GeoCLIP 模型和 LLM 供应商、版本、权重路径，并支持热切换。对于敏感数据，可切换为自部署模型。
- **提示模板仓库**：将模板作为独立文件管理，支持按任务名称加载，并可通过版本控制进行 A/B 试验。
- **工具注册与权限控制**：为不同场景启用或禁用特定工具，并设置调用频率、用户权限和输出精度（如默认降到城市级）。
- **状态 Schema**：定义统一的 state 结构（`clues`, `hypotheses`, `candidates`, `evidence`, `final`），方便在不同任务间重用序列解析和存储。

## 编排与状态管理

### 1. 状态定义

状态对象保存 Agent 在推理过程中的所有中间结果，并为下一步提供上下文。推荐使用如下结构：

```json
{
  "clues": {
    "ocr": [{"text": "...", "bbox": [...], "confidence": 0.9, "lang": "..."}],
    "visual": [{"type": "road_marking | vegetation | architecture | landmark", "value": "...", "confidence": 0.7}],
    "meta": {"exif": {...}}
  },
  "hypotheses": [
    {"region": "Japan/Tokyo", "rationale": ["..."], "supporting": ["..."], "conflicts": ["..."]}
  ],
  "candidates": [
    {"name": "...", "lat": ..., "lon": ..., "source": "poi_search", "score": 0.62}
  ],
  "evidence": [
    {"candidate": "...", "check": "ocr_poi_match", "result": "pass", "details": {...}}
  ],
  "final": {"answer": "...", "confidence": 0.74, "why": "...", "why_not": ["..."]}
}
```

### 2. LangGraph 流程设计

可以使用 LangGraph 将 PHRV 拆分为可观察的节点：

- **ExtractCluesNode** – 输入图片列表，调用 VLM （或 `vision_zoom_tile` 等工具）提取 clues，然后更新 `state.clues`。
- **ProposeHypothesesNode** – 根据 clues 调用 LLM 生成地理假设，结果填入 `state.hypotheses`。
- **RetrieveCandidatesNode** – 调用 GeoCLIP 检索图片坐标候选，并通过工具 `geocode` / `poi_search` 补全文本候选，填入 `state.candidates`。
- **VerifyNode** – 对每个候选调用验证工具，将结果写入 `state.evidence`，并根据阈值决定是否终止循环或调用下一轮。
- **FinalizeNode** – 当验证成功或达到迭代上限时，调用 LLM 根据 state 撰写最终答案和解释，填充 `state.final`。

节点间通过条件跳转（如 evidence 中存在"pass"）来控制循环。这样既能在成功时快速终止，又能记录每轮失败的原因。

### 3. Sandbox 集成

沙盒允许 Agent 在隔离环境中运行自定义代码，对外部工具不易覆盖的任务进行扩展：

- **EXIF 解析**：编写 Python 脚本提取图片的拍摄时间、GPS 信息等元数据并写入 `state.meta`；
- **批量检索与过滤**：使用 pandas 在沙盒中批量处理 GeoCLIP 输出的坐标，过滤重复或异常值，然后再调用 MCP 接口；
- **生成报告或图表**：通过 Python 在 sandbox 生成可视化报表，展示候选位置概率分布，便于用户理解。

沙盒代码调用应当通过 `python_user_visible` 工具执行，并遵守安全限制（禁止外网访问）。调用结果可以作为 evidence 引用。

## 场景扩展模板

基于上述设计，可以快速构建其他情景的多模态推理 Agent：

### 物体识别与选购
在 Perception 阶段提取物品特征，在 Hypothesis 阶段生成可能的商品类别，检索电商平台 API 获得候选商品，在 Verification 阶段比较规格、价格、用户评价，最后推荐最佳商品。

### 科学论文检索
用文本摘要作为输入，生成检索关键词和假设领域，调用学术搜索 API 获取候选文献，再核查引用次数和摘要匹配度。

### 医疗影像辅助
在 Perception 阶段抽取影像特征和患者数据，在 Hypothesis 阶段生成潜在诊断，在 Retrieval 阶段查询医学数据库与指南，Verification 阶段核查临床试验结果与标准，再输出诊断建议。

改动点主要集中在：线索类型、假设生成规则、调用的工具以及终止条件，流程框架与状态管理保持不变。模板化的提示和工具接口使开发者只需添加新的组件而无需改动核心逻辑。

## 部署与实现建议

### 1. 搭建 VLM 服务
根据数据敏感程度选择托管或自部署。对敏感场景，建议使用自部署的 LLaVA/Qwen‑VL，并通过网关包装成兼容 `/v1/chat/completions` 的 API，方便切换。此网关既可转发到 GPU 服务，也可以转发到第三方推理 API。为了保证地理定位准确度，应启用高分辨率输入和局部裁剪。

### 2. 部署 GeoCLIP
模型参数约 90M，可运行于单 GPU 或 CPU。GeoCLIP 通过对比学习将图像特征与 GPS 坐标对齐，利用 4.7 百万跨全球图片训练，使模型学习各地独特视觉特征。部署时可缓存全球坐标嵌入，加速 Top‑K 检索。

### 3. MCP 工具注册
结合公司内部地图/POI 服务或第三方 API，实现 `geocode`, `reverse_geocode`, `poi_search` 等接口；注册后通过统一的工具管理层供 Agent 调用。

### 4. LangGraph/LangChain 编排
根据上述节点划分实现状态机/有向图；利用内置的"循环直到"机制简化迭代。对于每个节点可定义输入参数、输出解析器及错误处理逻辑。

### 5. 日志与监控
记录每一轮 state 变化、调用的工具及返回值，方便分析异常情况；对外部 API 调用增加重试与超时策略。

## 安全与合规

### 隐私保护
默认对输出的地理位置降精度，仅在证据充分且用户有合理用途时返回精确坐标。对个人住宅或敏感场所禁止输出具体地址。禁止使用地理定位协助骚扰或人肉搜索。

### 信息安全
沙盒执行的代码不得访问外网，禁止下载未授权的模型或数据；对外部工具调用需限制参数，避免 SQL 注入或反序列化攻击。

### 数据治理
所有输入图片和工具返回的内容应符合当地数据保护法规；对输入图像中的个人信息、车牌等可先模糊化再处理。

## 总结

本文档提出了一种**通用且可扩展的多模态推理 Agent 框架**，以地理定位为案例验证了其有效性。通过 PHRV 流程、模块化组件、统一的状态管理以及 LangGraph/LangChain 编排，该框架既能减少幻觉、提升正确率，也能快速适配其它场景。GeoCLIP 提供的全球图像‑GPS 检索能力结合工具验证成为关键支撑，而提示模板与沙盒集成则让系统具备灵活的扩展性。未来可将本框架用于更多领域，如电商推荐、学术检索或医疗辅助，进一步验证其通用性与可靠性。

